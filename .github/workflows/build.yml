name: Build schemas classes

on:
  push:
    branches:
      - update-pipeline-workflow
    paths-ignore:
      - 'README.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Run build
        run: |
          pip install -r requirements.txt
          python build.py

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main
          token: ${{ secrets.GITHUB_TOKEN }}
          #ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Copy changes to main
        run: |
          rm -rf main/code/types/*
          rm -rf main/code/mixedtypes/*
          rm -rf main/code/enumerations/*
          cp -R target/* main/code
          cp -R main/code/internal/resources/content_files/* main/code/
          cp -R main/code/internal/resources/readme_files/* main/code/

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: latest
          cache: true

      - name: Install MatBox
        uses: ehennestad/matbox-actions/install-matbox@v1

      - name: Run tests
        id: test_step
        uses: ehennestad/matbox-actions/test-code@v1
        with:
          source_directory: main/code
          tests_directory: main/tools/tests
          tools_directory: main/tools

      - name: Push to main if tests pass
        run: |
          cd main
          git config --global user.email "openminds@ebrains.eu"
          git config --global user.name "openMINDS pipeline"
      
          # Conditionally set commit message based on the event
          if [ "${{ github.event_name }}" == "push" ]; then
            commit_message="Build triggered by update to build pipeline"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            commit_message="Build triggered by workflow dispatch"
          else
            commit_message="Unknown event"
          fi
      
          # Only proceed with commit and push if changes are detected
          if [[ $(git add . --dry-run | wc -l) -gt 0 ]]; then
            git add .
            git commit -m "$commit_message"
            git push -f
          else
            echo "Nothing to commit"
          fi

